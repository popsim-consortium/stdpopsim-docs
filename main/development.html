<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Development &mdash; stdpopsim 0.1.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changelogs" href="changelogs.html" />
    <link rel="prev" title="API" href="api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> stdpopsim
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="catalog.html">Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli_arguments.html">Command-line options</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-a-virtual-environment">Using a Virtual Environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#github-workflow">GitHub workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-commit-checks">Pre-commit checks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rebasing">Rebasing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-rebasing-goes-wrong">When rebasing goes wrong</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-new-demographic-model">Adding a new demographic model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-models-are-appropriate-to-add">What models are appropriate to add?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fork-the-repository-and-create-a-branch">Fork the repository and create a branch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#write-the-model-function-in-the-catalog-source-code">Write the model function in the catalog source code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#write-parameter-table">Write parameter table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-the-model-locally">Test the model locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#submit-a-pull-request-on-github">Submit a Pull Request on GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="#so-the-model-is-implemented-what-next">So the model is implemented. What next?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demographic-model-review-process">Demographic model review process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arbitration">Arbitration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-new-species">Adding a new species</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-updating-a-genome-definition">Adding/Updating a genome definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tests-for-new-species">Tests for new species</a></li>
<li class="toctree-l3"><a class="reference internal" href="#species-review-process">Species review process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-genetic-map">Adding a genetic map</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lifting-over-a-genetic-map">Lifting over a genetic map</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-dfe-model">Adding a DFE model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coding-standards">Coding standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="#naming-conventions">Naming conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unit-tests">Unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-coverage">Code Coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-a-new-release">Making a new release</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelogs.html">Changelogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">stdpopsim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Development</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/development.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="development">
<span id="sec-development"></span><h1>Development<a class="headerlink" href="#development" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> <strong>is a community effort, and we welcome YOU to join us!</strong></p>
<p>We envision at least three main types of <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> developers:</p>
<ol class="arabic simple">
<li><p>Demographic model contributors</p></li>
<li><p>API developers</p></li>
<li><p>Documentation and tutorial curators</p></li>
</ol>
<p><cite>Demographic model contributors</cite> add simulation code of published models.
This could be your own published model or any other published model you think
would be useful. This is the main way we envision biologists to continually add
to the catalog of available models, and it is a great first step for new
contributors to learn the ins and outs of <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> development. See the
sections <a class="reference internal" href="#adding-a-new-demographic-model">Adding a new demographic model</a> and
<a class="reference internal" href="#demographic-model-review-process">Demographic model review process</a> to get started.</p>
<p><cite>API developers</cite> work on infrastructure development for the PopSim Consortium,
which could include improvements and additions to the internal code base of
<code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code>, establishment of benchmarking pipelines,
and new projects that align with consortium goals.</p>
<p><cite>Documentation and tutorial curators</cite> help maintain the documentation and tutorials.
This can be as easy as pointing out confusing bits of the documentation in a
GitHub <a class="reference external" href="http://github.com/popgensims/stdpopsim/issues">issue</a>., or adding or editing
the documentation. See the section <a class="reference internal" href="#documentation">Documentation</a>.</p>
<p>Get into contact with the <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> community by subscribing to our email list
<a class="reference external" href="https://lists.uoregon.edu/mailman/listinfo/popgen_benchmark">serve</a>
and by creating and commenting on
Github <a class="reference external" href="http://github.com/popgensims/stdpopsim/issues">issue</a>.
There is a lot of chatter through
<a class="reference external" href="http://github.com/popgensims/stdpopsim">Github</a>, and we’ve been building code
there cooperatively.
If you want to help out and don’t know where to start, you can look through the
list of
<a class="reference external" href="https://github.com/popgensims/stdpopsim/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22">Good first issues</a>
or
<a class="reference external" href="https://github.com/popgensims/stdpopsim/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22">Help wanted issues</a></p>
<p>To get started helping with <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> development, please read the
following sections to learn how to contribute.
And, importantly, please have a look at our
<a class="reference external" href="https://github.com/popsim-consortium/stdpopsim/blob/main/CODE_OF_CONDUCT.md">code of conduct</a>.</p>
<section id="installation">
<span id="sec-development-installation"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h2>
<p>Before installing, be sure to make a fork of the repo and clone it locally
following the instructions in the <a class="reference internal" href="#github-workflow">GitHub Workflow</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> library requires Python 3.4 or later.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">pip</span></code> users, install the packages required for development using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install -r requirements/development.txt
</pre></div>
</div>
<p>You can then install the development version of <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 setup.py install
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">conda</span></code> users, you will need to add the conda-forge channel to your conda
environment and then should be able to install the development requirements using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda config --add channels conda-forge
$ conda install --file=requirements/development.txt
</pre></div>
</div>
<p>We do require <code class="docutils literal notranslate"><span class="pre">msprime</span></code>, so please see the the <a class="reference external" href="https://tskit.dev/msprime/docs/stable/installation.html">installation notes</a> if you
encounter problems with it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have trouble installing any of the requirements, your <code class="docutils literal notranslate"><span class="pre">pip</span></code> may be the wrong version.
Try <code class="docutils literal notranslate"><span class="pre">pip3</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements/development.txt</span></code></p>
</div>
<section id="using-a-virtual-environment">
<h3>Using a Virtual Environment<a class="headerlink" href="#using-a-virtual-environment" title="Permalink to this headline"></a></h3>
<p>We encourage the use of a virtual environment.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">pip</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">venv</span></code>.</p>
<p>First, create the virtual environment (You only need to do this once):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -m venv stdpopsim_env
</pre></div>
</div>
<p>Next, activate the virtual environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ source stdpopsim_env/bin/activate
</pre></div>
</div>
<p>You will then see the virtual environment in your prompt. Like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(stdpopsim_env) $
</pre></div>
</div>
<p>Once the virtual environment is activated, install the requirements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(stdpopsim_env) $ python3 -m pip install -r requirements/development.txt
</pre></div>
</div>
<p>You can then run any of the code in the virtual environment with the packages installed,
without conflicting with other packages in your local environment.
To deactivate the virtual environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(stdpopsim_env) $ deactivate
</pre></div>
</div>
</section>
</section>
<section id="github-workflow">
<h2>GitHub workflow<a class="headerlink" href="#github-workflow" title="Permalink to this headline"></a></h2>
<blockquote>
<div><ol class="arabic">
<li><p>Make your own <a class="reference external" href="https://help.github.com/articles/fork-a-repo/">fork</a>
of the <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> repository on GitHub, and
<a class="reference external" href="https://help.github.com/articles/cloning-a-repository/">clone</a>
a local copy.</p></li>
<li><p>Install the pre-commit hooks with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pre-commit install
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>Make sure that your local repository has been configured with an
<a class="reference external" href="https://help.github.com/articles/configuring-a-remote-for-a-fork/">upstream remote</a>.</p></li>
<li><p>Create a “topic branch” to work on. One reliable way to do it
is to follow this recipe:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git fetch upstream
$ git checkout upstream/main
$ git checkout -b topic_branch_name
</pre></div>
</div>
</li>
<li><p>As you work on your topic branch you can add commits to it. Once you’re
ready to share this, you can then open a <a class="reference external" href="https://help.github.com/articles/about-pull-requests/">pull request</a>. Your PR will
be reviewed by some of the maintainers, who may ask you to make changes.</p></li>
<li><p>If your topic branch has been around for a long time and has gotten
out of date with the main repository, we might ask you to
<a class="reference external" href="https://help.github.com/articles/about-git-rebase/">rebase</a>. Please
see the next section on how to rebase.</p></li>
</ol>
</div></blockquote>
<section id="pre-commit-checks">
<h3>Pre-commit checks<a class="headerlink" href="#pre-commit-checks" title="Permalink to this headline"></a></h3>
<p>On each commit a <a class="reference external" href="https://pre-commit.com/">pre-commit hook</a>  will run
that checks for violations of code style and other common problems.
Where possible, these hooks will try to fix any problems that they find (including reformatting
your code to conform to the required style). In this case, the commit
will <em>not complete</em> and report that “files were modified by this hook”.
To include the changes that the hooks made, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> any
files that were modified and run <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span></code> (or, use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-a</span></code>
to commit all changed files.)</p>
<p>If you would like to run the checks without committing, use <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">run</span></code>
(but, note that this will <em>only</em> check changes that have been <em>staged</em>;
do <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">run</span> <span class="pre">--all</span></code> to check unstaged changes as well).
To bypass the checks (to save or get feedback on work-in-progress) use
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--no-verify</span></code></p>
</section>
<section id="rebasing">
<h3>Rebasing<a class="headerlink" href="#rebasing" title="Permalink to this headline"></a></h3>
<p>Rebasing is used for two basic tasks we might ask for during review:</p>
<ol class="arabic simple">
<li><p>Your topic branch has gotten out of date with the tip of <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code>
and needs to be updated.</p></li>
<li><p>Your topic branch has lots of messy commits, which need to be cleaned up
by “squashing”.</p></li>
</ol>
<p><a class="reference external" href="https://help.github.com/articles/about-git-rebase/">Rebasing</a> in git
basically means changing where your branch forked off the main code
in <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code>. A good way of visualising what’s happening is to
look at the <a class="reference external" href="https://github.com/popgensims/stdpopsim/network">Network</a> view on
GitHub. This shows you all the forks and branches that GitHub knows about
and how they relate to the main repository. Rebasing lets you change where
your branch splits off.</p>
<p>To see this for your local repo
on your computer, you can look at the Git graph output via the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  git log --decorate --oneline --graph
</pre></div>
</div>
<p>This will show something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>|*   923ab2e Merge pull request #9 from mcveanlab/docs-initial
|\
| * 0190a92 (origin/docs-initial, docs-initial) First pass at development docs.
| * 2a5fc09 Initial outline for docs.
| * 1ccb970 Initial addition of docs infrastructure.
|/
*   c49601f Merge pull request #8 from mcveanlab/better-genomes
|\
| * fab9310 (origin/better-genomes, better-genomes) Added pongo tests.
| * 62c9560 Tidied up example.
| * 51e21e8 Added basic tests for population models.
| * 6fff557 Split genetic_maps into own module.
| * 90d6367 Added Genome concept.
| * e2aaf95 Changed debug to info for logging on download.
| * 2fbdfdc Added badges for CircleCI and CodeCov.
|/
*   c66b575 Merge pull request #5 from mcveanlab/tests-ci
|\
| * 3ae454f (origin/tests-ci, tests-ci) Initial circle CI config.
| * c39415a Added basic tests for genetic map downloads.
|/
*   dd47000 Merge pull request #3 from mcveanlab/recomb-map-infrastructure
|\
</pre></div>
</div>
<p>This shows a nice, linear git history: we can see four pull requests, each of
which consists of a small number of meaningful commits. This is the ideal that
we’re aiming for, and git allows us to achieve it by <em>rewriting history</em> as
much as we want within our own forks (we never rewrite history in the
<code class="docutils literal notranslate"><span class="pre">upstream</span></code> repository, as this would cause problems for other developers).
Having a clean, linear git history is a good idea for lots of reasons, not
least of which is making <a class="reference external" href="https://git-scm.com/docs/git-bisect">git bisect</a>
easier.</p>
<p>One of the most useful things that we can do with rebasing is to “squash” commits
so that we remove some noise from the git history. For example, this PR
(on the branch <code class="docutils literal notranslate"><span class="pre">topic_branch_name</span></code>) currently looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$  git log --decorate --oneline --graph

* 97a9458 (HEAD -&gt; topic_branch_name) DONE!!!
* c9c4a28 PLEASE work, CI!
* ad4c807 Please work, CI!
* 0fe6dc4 Please work, CI!
* 520e6ac Add documentation for rebasing.
*   20fb835 (upstream/main) Merge pull request #22 from mcveanlab/port-tennyson
|\
| * b3d45ea (origin/port-tennyson, port-tennyson) Quickly port Tennesen et al model.
|/
*   79d26b4 Merge pull request #20 from andrewkern/fly_model
|\
</pre></div>
</div>
<p>Here, in my initial commit (520e6ac) I’ve added some updated documentation for rebasing.
Then, there’s four more commits where I’m trying
to get CI pass. History doesn’t need to know about this, so I can rewrite it
using rebase:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ git fetch upstream
$ git rebase -i upstream/main
</pre></div>
</div>
<p>We first make sure that we’re rebasing against the most recent version of the
upstream repo. Then, we ask git to perform an interactive rebase against
the <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code> branch. This starts up your editor, showing something
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pick 520e6ac Add documentation for rebasing.
pick 0fe6dc4 Please work, CI!
pick ad4c807 Please work, CI!
pick c9c4a28 PLEASE work, CI!
pick 97a9458 DONE!!!

# Rebase 20fb835..97a9458 onto 20fb835 (5 commands)
#
# Commands:
# p, pick = use commit
# r, reword = use commit, but edit the commit message
# e, edit = use commit, but stop for amending
# s, squash = use commit, but meld into previous commit
# f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message
# x, exec = run command (the rest of the line) using shell
# d, drop = remove commit
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
</pre></div>
</div>
<p>We want git to squash the last five commits, so we edit the rebase instructions
to look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pick 520e6ac Add documentation for rebasing.
s 0fe6dc4 Please work, CI!
s ad4c807 Please work, CI!
s c9c4a28 PLEASE work, CI!
s 97a9458 DONE!!!

# Rebase 20fb835..97a9458 onto 20fb835 (5 commands)
#
# Commands:
# p, pick = use commit
# r, reword = use commit, but edit the commit message
# e, edit = use commit, but stop for amending
# s, squash = use commit, but meld into previous commit
# f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message
# x, exec = run command (the rest of the line) using shell
# d, drop = remove commit
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
</pre></div>
</div>
<p>After performing these edits, we then save and close. Git will try to do
the rebasing, and if successful will open another editor screen that
lets you edit the text of the commit message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># This is a combination of 5 commits.
# This is the 1st commit message:

Add documentation for rebasing.

# This is the commit message #2:

Please work, CI!

# This is the commit message #3:

Please work, CI!

# This is the commit message #4:

PLEASE work, CI!

# This is the commit message #5:

DONE!!!

# Please enter the commit message for your changes. Lines starting
# with &#39;#&#39; will be ignored, and an empty message aborts the commit.
#
# Date:      Tue Mar 5 17:00:39 2019 +0000
#
# interactive rebase in progress; onto 20fb835
# Last commands done (5 commands done):
#    squash c9c4a28 PLEASE work, CI!
#    squash 97a9458 DONE!!!
# No commands remaining.
# You are currently rebasing branch &#39;topic_branch_name&#39; on &#39;20fb835&#39;.
#
# Changes to be committed:
#       modified:   docs/development.rst
#
#
</pre></div>
</div>
<p>We don’t care about the commit messages for the squashed commits, so we
delete them and end up with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Add documentation for rebasing.

# Please enter the commit message for your changes. Lines starting
# with &#39;#&#39; will be ignored, and an empty message aborts the commit.
#
# Date:      Tue Mar 5 17:00:39 2019 +0000
#
# interactive rebase in progress; onto 20fb835
# Last commands done (5 commands done):
#    squash c9c4a28 PLEASE work, CI!
#    squash 97a9458 DONE!!!
# No commands remaining.
# You are currently rebasing branch &#39;topic_branch_name&#39; on &#39;20fb835&#39;.
#
# Changes to be committed:
#       modified:   docs/development.rst
</pre></div>
</div>
<p>After saving and closing this editor session, we then get something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[detached HEAD 6b8a2a5] Add documentation for rebasing.
Date: Tue Mar 5 17:00:39 2019 +0000
1 file changed, 2 insertions(+), 2 deletions(-)
Successfully rebased and updated refs/heads/topic_branch_name.
</pre></div>
</div>
<p>Finally, after a successful rebase, you <strong>must force-push</strong>! If you try to
push without specifying <code class="docutils literal notranslate"><span class="pre">-f</span></code>, you will get a very confusing and misleading
message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ git push origin topic_branch_name
To github.com:jeromekelleher/stdpopsim.git
! [rejected]        topic_branch_name -&gt; topic_branch_name (non-fast-forward)
error: failed to push some refs to &#39;git@github.com:jeromekelleher/stdpopsim.git&#39;
hint: Updates were rejected because the tip of your current branch is behind
hint: its remote counterpart. Integrate the remote changes (e.g.
hint: &#39;git pull ...&#39;) before pushing again.
hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.
</pre></div>
</div>
<p><strong>DO NOT LISTEN TO GIT IN THIS CASE!</strong> Git is giving you <strong>terrible advice</strong>
which will mess up your branch. What we need to do is replace the state of
the branch <code class="docutils literal notranslate"><span class="pre">topic_branch_name</span></code> on your fork on GitHub (the <code class="docutils literal notranslate"><span class="pre">upstream</span></code> remote)
with the state of your local branch, <code class="docutils literal notranslate"><span class="pre">topic_branch_name</span></code>. We do this
by “force-pushing”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ git push -f origin topic_branch_name
Counting objects: 4, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 4.33 KiB | 1.44 MiB/s, done.
Total 4 (delta 2), reused 0 (delta 0)
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To github.com:jeromekelleher/stdpopsim.git
 + 6b8a2a5...d033ffa topic_branch_name -&gt; topic_branch_name (forced update)
</pre></div>
</div>
<p>Success! We can check the history again to see if everything looks OK:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$  git log --decorate --oneline --graph

* d033ffa (HEAD -&gt; topic_branch_name, origin/topic_branch_name) Add documentation for rebasing.
*   20fb835 (upstream/main) Merge pull request #22 from mcveanlab/port-tennyson
|\
| * b3d45ea (origin/port-tennyson, port-tennyson) Quickly port Tennesen et al model.
|/
*   79d26b4 Merge pull request #20 from andrewkern/fly_model
|
</pre></div>
</div>
<p>This looks just right: we have one commit, pointing to the head of <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code>
and have successfully squashed and rebased.</p>
</section>
<section id="when-rebasing-goes-wrong">
<h3>When rebasing goes wrong<a class="headerlink" href="#when-rebasing-goes-wrong" title="Permalink to this headline"></a></h3>
<p>Sometimes rebasing goes wrong, and you end up in a frustrating loop of making
and undoing the same changes over and over again. First, here’s an explanation
of what’s going on. Let’s say that the branch we’re working on (and trying to
rebase) is called <code class="docutils literal notranslate"><span class="pre">topic_branch</span></code>, and it branched off from <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code>
at some point in the past:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">A1</span><span class="o">---</span><span class="n">A2</span><span class="o">---</span><span class="n">A3</span>  <span class="p">(</span><span class="n">topic_branch</span><span class="p">)</span>
    <span class="o">/</span>
<span class="o">---</span><span class="n">M</span><span class="o">---</span><span class="n">o</span><span class="o">---</span><span class="n">o</span><span class="o">---</span><span class="n">o</span><span class="o">---</span><span class="n">o</span><span class="o">---</span><span class="n">B</span>  <span class="p">(</span><span class="n">upstream</span><span class="o">/</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>So, what we’d really like to do is to take the commits <code class="docutils literal notranslate"><span class="pre">A1</span></code>, <code class="docutils literal notranslate"><span class="pre">A2</span></code>, and
<code class="docutils literal notranslate"><span class="pre">A3</span></code> and apply them to the current state of the <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code> branch,
i.e., on top of commit <code class="docutils literal notranslate"><span class="pre">B</span></code>. If we just do <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rebase</span> <span class="pre">upstream/main</span></code>
then git will try to first apply <code class="docutils literal notranslate"><span class="pre">A1</span></code>; then <code class="docutils literal notranslate"><span class="pre">A2</span></code>; and finally <code class="docutils literal notranslate"><span class="pre">A3</span></code>.
If there’s conflicts, this is painful, so we might want to <em>first</em> squash
the three commits together into one commit, and then rebase that single commit.
Then we’ll only have to resolve conflicts once. Said another way: we often
use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rebase</span> <span class="pre">-i</span> <span class="pre">upstream/main</span></code> to both squash <em>and</em> rebase; but
it may be easier to squash first then rebase after.</p>
<p>We’ll be doing irreversible changes, so first we should make a backup copy of
the branch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git checkout topic_branch  # make sure we&#39;re on the right branch
$ git checkout -b topic_backup # make the backup
$ git checkout topic_branch  # go back to the topic branch
</pre></div>
</div>
<p>Next, we take the diff between the current state of the files and the place
where your changes last diverged from <code class="docutils literal notranslate"><span class="pre">upstream/main</span></code> (the commit labelled
<code class="docutils literal notranslate"><span class="pre">M</span></code> in the diagram above), and save it as a patch. To do this, make sure
you are in the root of the git directory, and:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git diff --merge-base upstream/main &gt; changes.patch
</pre></div>
</div>
<p>After that, we can check out a fresh branch and check if everything works
as it’s supposed to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git checkout -b test_branch upstream/main
$ patch -p1 &lt; changes.patch
$ git commit -a
# check things work
</pre></div>
</div>
<p>After we’ve verified that everything works, we then checkout the original
topic branch and replace it with the state of the <code class="docutils literal notranslate"><span class="pre">test_branch</span></code>, and
finally force-push to the remote topic branch on your fork:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git checkout topic_branch
$ git reset --hard test_branch
$ git push -f origin topic_branch
</pre></div>
</div>
<p>Hard resetting and force pushing are not reversible operations, so please
beware! After you’ve done this, you can go make sure nothing bad happened
by checking that the only changes listed under “files changed” in the github
pull request are changes that you have made. For more on finding the fork
point, with diagrams, and an alternative workflow, see <a class="reference external" href="https://git-scm.com/docs/git-merge-base">the git docs</a>.</p>
</section>
</section>
<section id="adding-a-new-demographic-model">
<span id="sec-development-demographic-model"></span><h2>Adding a new demographic model<a class="headerlink" href="#adding-a-new-demographic-model" title="Permalink to this headline"></a></h2>
<p>Steps for adding a new demographic model:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#fork-the-repository-and-create-a-branch">Fork the repository and create a branch</a></p></li>
<li><p><a class="reference internal" href="#write-the-model-function-in-the-catalog-source-code">Write the model function in the catalog source code</a></p></li>
<li><p><a class="reference internal" href="#write-parameter-table">Write parameter table</a></p></li>
<li><p><a class="reference internal" href="#test-the-model-locally">Test the model locally</a></p></li>
<li><p><a class="reference internal" href="#submit-a-pull-request-on-github">Submit a Pull Request on GitHub</a></p></li>
</ol>
<p>If this is your first time implementing a demographic model in <cite>stdpopsim</cite>, it’s a good
idea to take some time browsing the <a class="reference internal" href="catalog.html#sec-catalog"><span class="std std-ref">Catalog</span></a>
and species’ demographic models in the
source code to see how existing models are typically written and documented. If you have
any questions or confusion about formatting or implementing demographic models, please
don’t hesitate to open an <a class="reference external" href="http://github.com/popgensims/stdpopsim/issues">issue</a> –
we’re more than happy to answer any questions and help get you up and running.</p>
<section id="what-models-are-appropriate-to-add">
<h3>What models are appropriate to add?<a class="headerlink" href="#what-models-are-appropriate-to-add" title="Permalink to this headline"></a></h3>
<p><cite>Stdpopsim</cite> supports any demographic model from the published literature that gives
enough information to be able to define <cite>msprime</cite> demography objects. At a minimum, that
includes population sizes and the timing of demographic events. These values need to
either be given in “physical” units (that is, raw population sizes and time units in
generations), or be able to be converted to physical units using, e.g., mutation rates
used in the published study.</p>
<p>Note that it is not necessary that the demographic model is attached to a particular
species. <cite>Stdpopsim</cite> contains a collection of generic models that are widely used in
developing and testing inference methods. If there is a generic model that does not
currently exist in our catalog but would be useful to include, we also welcome those
contributions. Again, you should provide a citation for a generic models, or it
should be commonly used.</p>
</section>
<section id="fork-the-repository-and-create-a-branch">
<h3>Fork the repository and create a branch<a class="headerlink" href="#fork-the-repository-and-create-a-branch" title="Permalink to this headline"></a></h3>
<p>Before implementing any model, be sure to have forked the <cite>stdpopsim</cite> repository
and cloned it locally, following the instructions in the <a class="reference internal" href="#github-workflow">GitHub Workflow</a> section.
Models are first implemented and tested locally, and then submitted as a pull request
to the <cite>stdpopsim</cite> repository, at which point it is verified by another developer
before being fully supported within <cite>stdpopsim</cite>.</p>
</section>
<section id="write-the-model-function-in-the-catalog-source-code">
<h3>Write the model function in the catalog source code<a class="headerlink" href="#write-the-model-function-in-the-catalog-source-code" title="Permalink to this headline"></a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> catalog source code (found in <code class="docutils literal notranslate"><span class="pre">stdpopsim/catalog/</span></code>),
each species has a module that defines all of the necessary functions to run
simulations for that species, including the demographic model. In each species module,
you will see that each type of function is divided by comments, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1"># Demographic models</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
</pre></div>
</div>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">Demographic</span> <span class="pre">models</span></code> section of the source code.
The demographic model function should follow this format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_model_func_name</span><span class="p">():</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;FILL ME&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;FILL ME&quot;</span>
    <span class="n">long_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    FILL ME</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">populations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">citations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Citation</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">,</span>
            <span class="n">year</span><span class="o">=</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">,</span>
            <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">,</span>
            <span class="n">reasons</span><span class="o">=</span><span class="p">{</span><span class="n">stdpopsim</span><span class="o">.</span><span class="n">CiteReason</span><span class="o">.</span><span class="n">DEM_MODEL</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">generation_time</span> <span class="o">=</span> <span class="s2">&quot;FILL ME&quot;</span>
    <span class="n">mutation_rate</span> <span class="o">=</span> <span class="s2">&quot;FILL ME&quot;</span>  <span class="c1"># per bp per generation</span>

    <span class="c1"># parameter value definitions based on published values</span>

    <span class="k">return</span> <span class="n">stdpopsim</span><span class="o">.</span><span class="n">DemographicModel</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">long_description</span><span class="p">,</span>
        <span class="n">populations</span><span class="o">=</span><span class="n">populations</span><span class="p">,</span>
        <span class="n">citations</span><span class="o">=</span><span class="n">citations</span><span class="p">,</span>
        <span class="n">generation_time</span><span class="o">=</span><span class="n">generation_time</span><span class="p">,</span>
        <span class="n">mutation_rate</span><span class="o">=</span><span class="n">mutation_rate</span><span class="p">,</span>
        <span class="n">population_configurations</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">],</span>
        <span class="n">migration_matrix</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">],</span>
        <span class="n">demographic_events</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FILL ME&quot;</span><span class="p">],</span>
    <span class="p">)</span>


<span class="n">_species</span><span class="o">.</span><span class="n">add_demographic_model</span><span class="p">(</span><span class="n">_model_func_name</span><span class="p">())</span>
</pre></div>
</div>
<p>The demographic model should include the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>: A unique, short-hand identifier for this demographic model. This <code class="docutils literal notranslate"><span class="pre">id</span></code>
contains a short description written in camel case, followed by an underscore, and then
four characters (the number of sampled populations, the first letter of the name of the
first author, and the year the study was published). For example, the Gutenkunst et al.
(2009) Out of Africa demographic model has the <code class="docutils literal notranslate"><span class="pre">id</span></code> “OutOfAfrica_3G09”. See
<a class="reference internal" href="#sec-development-naming-conventions"><span class="std std-ref">Naming conventions</span></a> for more details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">description</span></code>: A brief one-line description of the demographic model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">long_description</span></code>: A longer description (say, a concise paragraph) that describes
the model in more detail.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">populations</span></code>: A list of <code class="docutils literal notranslate"><span class="pre">stdpopsim.Population</span></code> objects, which have their own
<code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">description</span></code>. For example, the Thousand Genomes Project Yoruba panel
could be defined as <code class="docutils literal notranslate"><span class="pre">stdpopsim.Population(id=&quot;YRI&quot;,</span> <span class="pre">description=&quot;1000</span> <span class="pre">Genomes</span> <span class="pre">YRI</span>
<span class="pre">(Yorubans)&quot;)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">citations</span></code>: A list of <code class="docutils literal notranslate"><span class="pre">stdpopsim.Citation</span></code> objects for the appropriate citation
for this model. The citation object requires author, year, and doi information, and
a specified reason for citing this model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generation_time</span></code>: The generation time for the species in years. If you are
implementing a generic model, the generation time should default to 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mutation_rate</span></code>: The mutation rate assumed during the inference of this demographic
model, per bp per generation, if a mutation rate was used. If no mutation
rate is associated with this demographic model, which is generally uncommon
but possible, depending on the inference method, the mutation rate should be
set to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
</ul>
<p>Every demographic model has a few necessary features or attributes. First of all,
demographic models are defined by the population sizes, migration rates, split and
admixture times, and generation lengths given in the source publication. We often take
the point estimates for each of the values from the best fit model (for example, the
parameters that give the maximum likelihood fit), which are translated into
<cite>msprime</cite>-formatted demographic inputs.</p>
<p><cite>Msprime</cite>-defined demographic models are specified through the
<code class="docutils literal notranslate"><span class="pre">population_configurations</span></code>, <code class="docutils literal notranslate"><span class="pre">migration_matrix</span></code>, and <code class="docutils literal notranslate"><span class="pre">demographic_events</span></code>. If this
is your first time specifying a model using <cite>msprime</cite>, it’s worth taking some time to
read through the <cite>msprime</cite>
<a class="reference external" href="https://tskit.dev/msprime/docs/stable/quickstart.html">documentation and tutorials</a>.</p>
</section>
<section id="write-parameter-table">
<h3>Write parameter table<a class="headerlink" href="#write-parameter-table" title="Permalink to this headline"></a></h3>
<p>The parameters used in the implementation must
also be listed in a csv file in the <code class="docutils literal notranslate"><span class="pre">docs/parameter_tables</span></code> directory. This ensures
that the documentation for this model displays the parameters.</p>
<p>Take a look at the csv files currently in <code class="docutils literal notranslate"><span class="pre">docs/parameter_tables</span></code> for inspiration.
The csv file should have the format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Parameter</span> <span class="n">Type</span> <span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Description</span>
</pre></div>
</div>
<p>We can check that the documentation builds properly after implementation by running
<code class="docutils literal notranslate"><span class="pre">make</span></code> in the docs directory and opening the Catalog page from the <code class="docutils literal notranslate"><span class="pre">docs/_build/</span></code>
directory. See <a class="reference internal" href="#documentation">Documentation</a> for more details.</p>
</section>
<section id="test-the-model-locally">
<h3>Test the model locally<a class="headerlink" href="#test-the-model-locally" title="Permalink to this headline"></a></h3>
<p>Once you have written the demographic model function, you should test the model locally
with <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code>. Follow the development <a class="reference internal" href="#sec-development-installation"><span class="std std-ref">Installation</span></a>
instructions to install the development <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> version along with the
requirements.</p>
<p>Now check that your new demographic model function has been imported:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">stdpopsim</span>

<span class="n">species</span> <span class="o">=</span> <span class="n">stdpopsim</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="s2">&quot;HomSap&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">demographic_models</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># OutOfAfrica_3G09</span>
<span class="c1"># OutOfAfrica_2T12</span>
<span class="c1"># Africa_1T12</span>
<span class="c1"># AmericanAdmixture_4B11</span>
<span class="c1"># OutOfAfricaArchaicAdmixture_5R19</span>
<span class="c1"># Zigzag_1S14</span>
<span class="c1"># AncientEurasia_9K19</span>
<span class="c1"># PapuansOutOfAfrica_10J19</span>
<span class="c1"># AshkSub_7G19</span>
<span class="c1"># OutOfAfrica_4J17</span>
</pre></div>
</div>
<p>The example above lists the imported demographic models for humans.
You should substitute <code class="docutils literal notranslate"><span class="pre">&quot;HomSap&quot;</span></code> for which ever species you added your model to.
Your new model should be printed along with currently available demographic models.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your demographic model does not print, after defining your model function,
did you include the call <code class="docutils literal notranslate"><span class="pre">_species.add_demographic_model(_model_func_name())</span></code>,
where <code class="docutils literal notranslate"><span class="pre">_model_func_name()</span></code> is your model function name?</p>
<p>If you are still having trouble, check the
<a class="reference external" href="https://github.com/popsim-consortium/stdpopsim/issues?q=is%3Aissue+adding+demographic+model+">GitHub issues</a>,
or <a class="reference external" href="https://github.com/popsim-consortium/stdpopsim/issues/new">open an issue</a>.</p>
</div>
<p>Next, check that you can successfully run a simulation with your new model with the
Python API. See <a class="reference internal" href="tutorial.html#sec-python-tute"><span class="std std-ref">Running stdpopsim with the Python interface (API)</span></a> for more details.</p>
</section>
<section id="submit-a-pull-request-on-github">
<h3>Submit a Pull Request on GitHub<a class="headerlink" href="#submit-a-pull-request-on-github" title="Permalink to this headline"></a></h3>
<p>Once you have implemented the demographic model locally, including
documentation, the next step is to open a pull request with this addition.
See the <a class="reference internal" href="#github-workflow">GitHub workflow</a> for more details.</p>
</section>
<section id="so-the-model-is-implemented-what-next">
<h3>So the model is implemented. What next?<a class="headerlink" href="#so-the-model-is-implemented-what-next" title="Permalink to this headline"></a></h3>
<p>Now at this point, most of your work is done!  The model is reviewed and
verified following the <a class="reference internal" href="#demographic-model-review-process">Demographic model review process</a> by an independent member
of the development team, and there may be some discussion about formatting and
to clear up any confusing bits of the demographic parameters before the model is
fully incorporated into <cite>stdpopsim</cite>.</p>
<p>Thank you for your contribution, and welcome to the <cite>stdpopsim</cite> development team!</p>
</section>
<section id="demographic-model-review-process">
<h3>Demographic model review process<a class="headerlink" href="#demographic-model-review-process" title="Permalink to this headline"></a></h3>
<p>When Developer A creates a new demographic model on their local fork they must
follow these steps for it to be officially supported by stdpopsim:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Developer A submits a PR to add a new model to the catalog. This includes
full documentation (i.e., the documentation that will be
rendered on rtd). The code is checked for any obvious problems/style
issues etc by a maintainer and merged when it meets these basic
standards. The new catalog model is considered ‘preliminary’.</p></li>
<li><p>Developer A creates an <a class="reference external" href="https://github.com/popsim-consortium/stdpopsim/issues/new/choose">issue</a>
tracking the QC for the model which includes information about the
primary sources used to create the model and the population indices
used for their msprime implementation. To create a new Model QC issue,
click “New issue” from the “Issues” tab on GitHub, and click “Get
started” to use the Model QC issue template. Follow the template to
include the necessary information in the issue. Developer B is then
assigned/volunteers to do a blind implementation of the model.</p></li>
<li><p>Developer B creates a blind implementation of the model in the
<code class="docutils literal notranslate"><span class="pre">stdpopsim/qc/species_name.py</span></code> file, remembering to register the
QC model implementation (see other QC models for examples).  Note that
if you are adding a new species you will have to add a new import to
<code class="docutils literal notranslate"><span class="pre">stdpopsim/qc/__init__.py</span></code>.</p></li>
<li><p>Developer B runs the units tests to verify the equivalence of the
catalog and QC model implementations.</p></li>
<li><p>Developer B then creates a PR, and all being good, this PR is merged and
the QC issue is closed.</p></li>
</ol>
</div></blockquote>
</section>
<section id="arbitration">
<h3>Arbitration<a class="headerlink" href="#arbitration" title="Permalink to this headline"></a></h3>
<p>When developers A and B disagree on the model implementation, the process is to:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Try to hash out the details between them on the original issue thread</p></li>
<li><p>If this fails, contact the authors of the original publication to resolve
ambiguities.</p></li>
<li><p>If changes have to be made to the production model Developer A submits a
PR with the hotfix for the production model. Developer B then rebases
the branch containing their PR against the main branch to check for model
equality. Repeat steps 1-3 until this is achieved. If changes have to be
made to the QC model they are committed to the branch where the QC PR
originates from.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="adding-a-new-species">
<h2>Adding a new species<a class="headerlink" href="#adding-a-new-species" title="Permalink to this headline"></a></h2>
<p>To add a new species to <cite>stdpopsim</cite> several things are required:</p>
<ol class="arabic simple">
<li><p>The genome definition</p></li>
<li><p>Generation time estimate</p></li>
<li><p>Mutation rate (per generation)</p></li>
<li><p>Recombination rate (per generation)</p></li>
<li><p>Characteristic population size</p></li>
</ol>
<p>A genetic map with local recombination rates is optional.</p>
<p>These parameters should be based on what values might be drawn from a typical population
as represented in the literature for that species. Consequently one or more citations for
each value are expected and will be required for constructing the species object detailed
below.</p>
<p>Once you have these things the first step is to create a new subdirectory of the <cite>catalog/</cite>
directory named for the species (see <a class="reference internal" href="#naming-conventions">Naming conventions</a> for more details). All
code described below should go in this directory unless explicitly specified otherwise.</p>
<section id="adding-updating-a-genome-definition">
<h3>Adding/Updating a genome definition<a class="headerlink" href="#adding-updating-a-genome-definition" title="Permalink to this headline"></a></h3>
<p><cite>stdpopsim</cite> has an automated procedure for generating a genome definition, which is
accomplished by pulling data from Ensembl and saving it for parsing. To do this,
hand the <cite>maintenance</cite> command line interface a “_” delimited Ensembl species ID as a
positional argument as shown below. A partial list of the
genomes housed on Ensembl can be found <a class="reference external" href="https://metazoa.ensembl.org/species.html">here</a>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python -m maintenance add-species arabidopsis_thaliana
</pre></div>
</div>
<p>This will generate new files inside <cite>catalog/{species_id}/</cite>:</p>
<ul class="simple">
<li><p>genome_data.py</p></li>
<li><p>species.py</p></li>
<li><p>__init__.py</p></li>
</ul>
<p>The genome_data.py file contains the physical map of the genome; the <cite>maintenance</cite> utility sucks down a whole lot of useful information for free. This genome_data.py essentially puts together a data dictionary which has slots for the assembly accession number, the assembly name, and a dict representing the chromosome names and their associated lengths. If synonyns are defined (e.g., chr2L for 2L) then those are given in the list that follows. There is no reason to edit this file– we are good here.</p>
<p>Next, the species.py file will need to be edited with the species-specific information and corresponding citations. Inside this file are commented instructions for ech section. Either chromosome-specific or genome-wide recombination rates and mutations rates can be used at this stage; the citations attached to these rates will be filled in inside the code block beginning with <cite>_genome</cite>. For example, below is the _genome code block for <cite>A. thaliana</cite> with citations included:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_genome</span> <span class="o">=</span> <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Genome</span><span class="p">(</span>
    <span class="n">chromosomes</span><span class="o">=</span><span class="n">_chromosomes</span><span class="p">,</span>
    <span class="n">assembly_name</span><span class="o">=</span><span class="n">genome_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assembly_name&quot;</span><span class="p">],</span>
    <span class="n">assembly_accession</span><span class="o">=</span><span class="n">genome_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assembly_accession&quot;</span><span class="p">],</span>
    <span class="n">citations</span><span class="o">=</span><span class="p">[</span>
        <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Citation</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="s2">&quot;Ossowski et al.&quot;</span><span class="p">,</span>
            <span class="n">year</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
            <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;https://doi.org/10.1126/science.1180677&quot;</span><span class="p">,</span>
            <span class="n">reasons</span><span class="o">=</span><span class="p">{</span><span class="n">stdpopsim</span><span class="o">.</span><span class="n">CiteReason</span><span class="o">.</span><span class="n">MUT_RATE</span><span class="p">},</span>
        <span class="p">),</span>
        <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Citation</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="s2">&quot;Huber et al.&quot;</span><span class="p">,</span>
            <span class="n">year</span><span class="o">=</span><span class="mi">2014</span><span class="p">,</span>
            <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;https://doi.org/10.1093/molbev/msu247&quot;</span><span class="p">,</span>
            <span class="n">reasons</span><span class="o">=</span><span class="p">{</span><span class="n">stdpopsim</span><span class="o">.</span><span class="n">CiteReason</span><span class="o">.</span><span class="n">REC_RATE</span><span class="p">},</span>
        <span class="p">),</span>
        <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Citation</span><span class="p">(</span>
            <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;https://doi.org/10.1093/nar/gkm965&quot;</span><span class="p">,</span>
            <span class="n">year</span><span class="o">=</span><span class="mi">2007</span><span class="p">,</span>
            <span class="n">author</span><span class="o">=</span><span class="s2">&quot;Swarbreck et al.&quot;</span><span class="p">,</span>
            <span class="n">reasons</span><span class="o">=</span><span class="p">{</span><span class="n">stdpopsim</span><span class="o">.</span><span class="n">CiteReason</span><span class="o">.</span><span class="n">ASSEMBLY</span><span class="p">},</span>
        <span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Generation time and population size, along with relevent citations, are filled in inside the code block beginning with <cite>_species</cite>. It may be useful to look at the existing species.py files inside the catalog/ directory for reference.</p>
<p>Once these fields have been entered, you should be able to load and simulate the newly added species using <cite>stdpopsim</cite>.</p>
</section>
<section id="tests-for-new-species">
<h3>Tests for new species<a class="headerlink" href="#tests-for-new-species" title="Permalink to this headline"></a></h3>
<p>Basic sanity tests for the new species will be completed through QC over in the <cite>tests/test_{species_id}.py</cite> file, which was also created by the add-species utility. To run the tests in stdpopsim we use the pytest module.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python -m pytest tests/test_AnoGam.py
</pre></div>
</div>
<p>This test checks for things related to missing information and formatting. For example, it wants the citation year to be of type <cite>int</cite> rather than <cite>str</cite> (i.e. no quotes).</p>
</section>
<section id="species-review-process">
<h3>Species review process<a class="headerlink" href="#species-review-process" title="Permalink to this headline"></a></h3>
<p>Once you are satisfied that the species can be simulated via the CLI, submit a pull
request with your changes. The species definition will go through a review process.
This process includes not only a code review, but also includes a QC process to double
check parameters and citations are appropriate.  To initiate the QC process, open a
new <a class="reference external" href="https://github.com/popsim-consortium/stdpopsim/issues/new/choose">issue</a>
using the ‘Species QC issue template’. One or more volunteers will check items off
the checklist, until all items have been completed satisfactorily. The QC issue,
or the pull request, may be used for review discussion. The new species will be
merged once the checklist is completed.</p>
</section>
</section>
<section id="adding-a-genetic-map">
<h2>Adding a genetic map<a class="headerlink" href="#adding-a-genetic-map" title="Permalink to this headline"></a></h2>
<p>Some species have sub-chromosomal recombination maps available. They can be added to
<cite>stdpopsim</cite> by creating a new <cite>GeneticMap</cite> object and providing a formatted file
detailing recombination rates to a designated <cite>stdpopsim</cite> maintainer who then uploads
it to AWS. If there is one for your species that you wish to include, create a space
delimited file with four columns: Chromosome, Position(bp), Rate(cM/Mb), and Map(cM).
Each chromosome should be placed in a separate file and with the chromosome id in the
file name in such a way that it can be programatically parsed out. IMPORTANT: chromosome
ids must match those provided in the genome definition exactly! Below is an example start
to a recombination map file (see <a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.RateMap.read_hapmap">here</a>
for more details):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Chromosome</span> <span class="n">Position</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="n">Rate</span><span class="p">(</span><span class="n">cM</span><span class="o">/</span><span class="n">Mb</span><span class="p">)</span> <span class="n">Map</span><span class="p">(</span><span class="n">cM</span><span class="p">)</span>
<span class="n">chr1</span> <span class="mi">32807</span> <span class="mf">5.016134</span> <span class="mi">0</span>
<span class="n">chr1</span> <span class="mi">488426</span> <span class="mf">4.579949</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Once you have the recombination map files formatted, tar and gzip them into a single
compressed archive. The gzipped tarball must be FLAT (there are no directories in the
tarball). This file will be sent to one of the <cite>stdpopsim</cite> uploaders for placement in the
AWS cloud once the new genetic map(s) are approved. Finally, you must add a <cite>GeneticMap</cite>
object to the file named for your species in the <cite>catalog</cite> directory (the same one in
which the genome is defined) as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_genetic_map_citation</span> <span class="o">=</span> <span class="n">stdpopsim</span><span class="o">.</span><span class="n">Citation</span><span class="p">(</span>
    <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">9999</span><span class="p">,</span> <span class="n">reasons</span><span class="o">=</span><span class="p">{</span><span class="n">stdpopsim</span><span class="o">.</span><span class="n">CiteReason</span><span class="o">.</span><span class="n">GEN_MAP</span><span class="p">}</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The file_pattern argument is a pattern that matches the recombination map filenames,</span>
<span class="sd">where &#39;{id}&#39; is replaced with the &#39;id&#39; field of a given chromosome.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">_gm</span> <span class="o">=</span> <span class="n">stdpopsim</span><span class="o">.</span><span class="n">GeneticMap</span><span class="p">(</span>
    <span class="n">species</span><span class="o">=</span><span class="n">_species</span><span class="p">,</span>
    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span>  <span class="c1"># ID for genetic map, see naming conventions</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span>
    <span class="n">long_description</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;https://stdpopsim.s3-us-west-2.amazonaws.com/genetic_maps/dir/filename&quot;</span><span class="p">),</span>
    <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;FILL_ME&quot;</span><span class="p">,</span>
    <span class="n">file_pattern</span><span class="o">=</span><span class="s2">&quot;name_</span><span class="si">{id}</span><span class="s2">_more_name.txt&quot;</span><span class="p">,</span>
    <span class="n">citations</span><span class="o">=</span><span class="p">[</span><span class="n">_genetic_map_citation</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">_species</span><span class="o">.</span><span class="n">add_genetic_map</span><span class="p">(</span><span class="n">_gm</span><span class="p">)</span>
</pre></div>
</div>
<p>The SHA256 checksum of the the genetic map tarball can be obtained using the
<code class="docutils literal notranslate"><span class="pre">sha256sum</span></code> command from GNU coreutils. If this is not available on your
system, the following can instead be used:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python -c <span class="s1">&#39;from stdpopsim.utils import sha256; print(sha256(&quot;genetic_map.tgz&quot;))&#39;</span>
</pre></div>
</div>
<p>Once all this is done, submit a PR containing the code changes and wait for directions
on whom to send the compressed archive of genetic maps to (currently Andrew Kern is the
primary uploader but please wait to send files to him until directed).</p>
</section>
<section id="lifting-over-a-genetic-map">
<h2>Lifting over a genetic map<a class="headerlink" href="#lifting-over-a-genetic-map" title="Permalink to this headline"></a></h2>
<p>Existing genetic maps will need to be lifted over to a new assembly, if and when the
current assembly is updated in <cite>stdpopsim</cite>. This process can be partially automated by running
the liftOver maintenance code.</p>
<p>First, you must download and install the <code class="docutils literal notranslate"><span class="pre">liftOver</span></code> executable from the
<a class="reference external" href="https://genome-store.ucsc.edu/">UCSC Genome Browser Store</a>.
Next, you must download the appropriate chain files, again from UCSC
(see <a class="reference external" href="http://hgdownload.soe.ucsc.edu/downloads.html#liftover">UCSC Genome Browser downloads</a> for more details).
To validate the remapping between assemblies it is required to have chain files
corresponding to both directions of the liftOver
(e.g. <cite>hg19ToHg38.over.chain.gz</cite> and <cite>hg38ToHg19.over.chain.gz</cite>) as in the
example below.</p>
<p>An example of the process for
lifting over the <cite>GeneticMap</cite> <code class="docutils literal notranslate"><span class="pre">&quot;HapMapII_GRCh37&quot;</span></code> to the <code class="docutils literal notranslate"><span class="pre">&quot;Hg19&quot;</span></code> assembly
is shown below:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python /maintenance/liftOver_catalog.py <span class="se">\</span>
    --species HomSap <span class="se">\</span>
    --map HapMapII_GRCh37 <span class="se">\</span>
    --chainFile hg19ToHg38.over.chain.gz <span class="se">\</span>
    --validationChain hg38ToHg19.over.chain.gz <span class="se">\</span>
    --winLen <span class="m">1000</span> <span class="se">\</span>
    --useAdjacentAvg <span class="se">\</span>
    --retainIntermediates <span class="se">\</span>
    --gapThresh <span class="m">1000000</span>
</pre></div>
</div>
<p>Here, the argument <code class="docutils literal notranslate"><span class="pre">&quot;--winLen&quot;</span></code> corresponds to the size of the window over which a weighted
average of recombination rates is taken when comparing the original map with the
back-lifted map (for validation purposes only). The argument <code class="docutils literal notranslate"><span class="pre">&quot;--gapThresh&quot;</span></code> is used to select a threshold for
which gaps in the new assembly longer than the <code class="docutils literal notranslate"><span class="pre">&quot;--gapThresh&quot;</span></code> will be set with a
recombination rate equal to 0.0000, instead of an average rate. The type of average rate used for gaps
shorter than the <code class="docutils literal notranslate"><span class="pre">&quot;--gapThresh&quot;</span></code> is determined either by using the mean rate of two most adjacent windows
or by using the mean rate for the entire chromosome, using options <code class="docutils literal notranslate"><span class="pre">&quot;--useAdjacentAvg&quot;</span></code> or
<code class="docutils literal notranslate"><span class="pre">&quot;--useChromosomeAvg&quot;`</span></code> respectively.</p>
<p>Validation plots will automatically be generated in the <code class="docutils literal notranslate"><span class="pre">&quot;/liftOver_validation/&quot;</span></code>
directory. Intermediate files created by the <code class="docutils literal notranslate"><span class="pre">liftOver</span></code> executable will be saved
for inspection in the <code class="docutils literal notranslate"><span class="pre">&quot;/liftOver_intermediates/&quot;</span></code>, only if the
<code class="docutils literal notranslate"><span class="pre">&quot;--retainInermediates&quot;</span></code> option is used. Once the user has inspected the validation plots
and deemed the liftOver process to be sufficiently accurate, they can proceed to generating
the SHA256 checksum.</p>
<p>The SHA256 checksum of the new genetic map tarball can be obtained using the
<code class="docutils literal notranslate"><span class="pre">sha256sum</span></code> command from GNU coreutils. If this is not available on your
system, the following can instead be used:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python -c <span class="s1">&#39;from stdpopsim.utils import sha256; print(sha256(&quot;genetic_map.tgz&quot;))&#39;</span>
</pre></div>
</div>
<p>The newly lifted over maps will be formatted in a compressed archive and
automatically named using the assembly name from the chain file.
This file will be sent to one of the <cite>stdpopsim</cite> uploaders for placement in the
AWS cloud, once the new map is approved. Finally, you must add a <cite>GeneticMap</cite>
object to the file named for your species in the <cite>catalog</cite> directory (the same one in
which the genome is defined) as shown in <a class="reference internal" href="#adding-a-genetic-map">Adding a genetic map</a>.</p>
<p>Again, once all this is done, submit a PR containing the code changes and wait for
directions on whom to send the compressed archive of genetic maps to
(currently Andrew Kern is the primary uploader but please wait to send files
to him until directed).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">GeneticMap</span></code> named <code class="docutils literal notranslate"><span class="pre">&quot;ComeronCrossoverV2_dm6&quot;</span></code> for <code class="docutils literal notranslate"><span class="pre">&quot;DroMel&quot;</span></code>
was generated by similar code (albeit slightly different
compared to that shown above) using the following command:</p>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python /maintenance/liftOver_comeron2012.py <span class="se">\</span>
    --winLen <span class="m">1000</span> <span class="se">\</span>
    --gapThresh <span class="m">1000000</span> <span class="se">\</span>
    --useAdjacentAvg <span class="se">\</span>
    --retainIntermediates
</pre></div>
</div>
</section>
<section id="adding-a-dfe-model">
<span id="sec-development-dfe-model"></span><h2>Adding a DFE model<a class="headerlink" href="#adding-a-dfe-model" title="Permalink to this headline"></a></h2>
<p>TODO: WRITE ME</p>
</section>
<section id="coding-standards">
<h2>Coding standards<a class="headerlink" href="#coding-standards" title="Permalink to this headline"></a></h2>
<p>To ensure that the code in <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> is as readable as possible
and follows a reasonably uniform style, we require that all code follows
the <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP8</a> style guide.
Lines of code should be no more than 89 characters.
Conformance to this style is checked as part of the Continuous Integration
testing suite.</p>
</section>
<section id="naming-conventions">
<span id="sec-development-naming-conventions"></span><h2>Naming conventions<a class="headerlink" href="#naming-conventions" title="Permalink to this headline"></a></h2>
<p>To ensure uniformity in naming schemes across objects in <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code>
we have strict conventions for species, genetic maps, and demographic
models.</p>
<p>Species names follow a <code class="docutils literal notranslate"><span class="pre">${first_3_letters_genus}${first_3_letters_species}</span></code>
convention with capitilization such that Homo sapiens becomes “HomSap”. This
is similar to the UCSC Genome Browser naming convention and should be familiar.</p>
<p>Genetic maps are named using a descriptive name and the assembly version according
to <code class="docutils literal notranslate"><span class="pre">${CamelCaseDescriptiveName}_${Assembly}</span></code>. e.g., the HapMap phase 2 map on
the GRCh37 assembly becomes HapMapII_GRCh37.</p>
<p>Demographic models are named using a combination of a descriptive name,
information about the simulation, and information about the publication it was
presented in. Specifically we use
<code class="docutils literal notranslate"><span class="pre">${SomethingDescriptive}_${number_of_populations}${first_author_initial}${two_digit_date}</span></code>
where the descriptive text is meant to capture something about the model
(i.e. an admixture model, a population crash, etc.) and the number of populations
is the number of populations implemented in the model (not necessarily the number
from which samples are drawn). For author initial we will use a single letter, the 1st,
until an ID collision, in which case we will include the 2nd letter, and so forth.</p>
<p>DFEs (Distributions of Fitness Effects) are similarly named using something descriptive
of the distribution, and information about the publication:
<code class="docutils literal notranslate"><span class="pre">${SomethingDescriptive}_${First_authors_last_name_first_letter}{two_digit_date}</span></code>.
For instance, if the distribution in question is a lognormal distribution,
then <code class="docutils literal notranslate"><span class="pre">LogNormal</span></code> might be the descriptive string.</p>
</section>
<section id="unit-tests">
<h2>Unit tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline"></a></h2>
<p>All code added to <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> should have
<a class="reference external" href="https://en.wikipedia.org/wiki/Unit_testing">unit tests</a>. These are typically
simple and fast checks to ensure that the code makes basic sense (the
entire unit test suite should not require more than a few seconds to run).
Test coverage is checked using <a class="reference external" href="https://codecov.io/gh/popgensims/stdpopsim">CodeCov</a>,
which generates reports about each pull request.</p>
<p>It is not practical to test the statistical properties of simulation models
as part of unit tests.</p>
<p>The unit test suite is in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory. Tests are run using the
<a class="reference external" href="https://docs.pytest.org/en/stable/">pytest</a> module. Use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -m pytest
</pre></div>
</div>
<p>from the project root to run the full test suite. Pytest is very powerful and
has lots of options; please see the <a class="reference external" href="https://tskit.dev/tskit/docs/stable/development.html#tests">tskit documentation</a> for help on
how to run pytest and some common options.</p>
<p>It’s useful to run the <code class="docutils literal notranslate"><span class="pre">flake8</span></code> CI tests <em>locally</em> before pushing a commit.
To set this up use either <code class="docutils literal notranslate"><span class="pre">pip</span></code> or <code class="docutils literal notranslate"><span class="pre">conda</span></code> to install <code class="docutils literal notranslate"><span class="pre">flake8</span></code></p>
<p>To run the test simply use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ flake8 --max-line-length 89 stdpopsim tests
</pre></div>
</div>
<p>If you would like to automatically run this test before a commit is permitted,
add the following line in the file <code class="docutils literal notranslate"><span class="pre">stdpopsim/.git/hooks/pre-commit.sample</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span> <span class="n">flake8</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">line</span><span class="o">-</span><span class="n">length</span> <span class="mi">89</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">stdpopsim</span> <span class="n">tests</span>
</pre></div>
</div>
<p>before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># If there are whitespace errors, print the offending file names and fail.
exec git diff-index --check --cached $against --
</pre></div>
</div>
<p>Finally, rename <code class="docutils literal notranslate"><span class="pre">pre-commit.sample</span></code> to simply <code class="docutils literal notranslate"><span class="pre">pre-commit</span></code></p>
</section>
<section id="code-coverage">
<h2>Code Coverage<a class="headerlink" href="#code-coverage" title="Permalink to this headline"></a></h2>
<p>As part of the continuous testing suite we have automated checking of how
well the test units cover the source code. As a result it’s very helpful
to check locally how well your tests are covering your code by asking
<cite>pytest</cite> for coverage reports. This can be done with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest --cov-report html --cov=stdpopsim tests/
</pre></div>
</div>
<p>this will output of directory of html files for you to browse test coverage
for every file in <cite>stdpopsim</cite> in a reasonably straightfoward graphical
way. You’ll be looking for lines of code that are highlighted yellow or red
indicated that tests do not currently cover that bit of code.</p>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline"></a></h2>
<p>Documentation is written using <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a>
markup and the <a class="reference external" href="http://www.sphinx-doc.org/en/master/">sphinx</a> documentation system.
It is defined in the <code class="docutils literal notranslate"><span class="pre">docs</span></code> directory.</p>
<p>To build the documentation type <code class="docutils literal notranslate"><span class="pre">make</span></code> in the <code class="docutils literal notranslate"><span class="pre">docs</span></code> directory. This should build
HTML output in the <code class="docutils literal notranslate"><span class="pre">_build/html/</span></code> directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will need <code class="docutils literal notranslate"><span class="pre">stdpopsim</span></code> to be installed for the build to work.</p>
</div>
</section>
<section id="making-a-new-release">
<h2>Making a new release<a class="headerlink" href="#making-a-new-release" title="Permalink to this headline"></a></h2>
<p>Here is a list of things to do when making a new release:</p>
<ol class="arabic simple">
<li><p>Update the changelog and commit</p></li>
<li><p>Create a release using the GitHub UI</p></li>
<li><dl class="simple">
<dt><cite>git fetch upstream</cite> on your local branch.</dt><dd><p>Then check out <cite>upstream/main</cite> and create a release tarball
(with <cite>python setup.py sdist</cite>).
Setuptools_scm will detect the version appopriately.</p>
</dd>
</dl>
</li>
<li><p>Upload to PyPI: <cite>twine upload dist/{version just tagged}.tar.gz</cite></p></li>
<li><p>After the release, if everything looks OK,
update the symlink for <code class="docutils literal notranslate"><span class="pre">stable</span></code> in the
<a class="reference external" href="https://github.com/popsim-consortium/stdpopsim-docs">stdpopsim-docs</a>
repository</p></li>
<li><p>Check on the conda feedstock PR.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api.html" class="btn btn-neutral float-left" title="API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelogs.html" class="btn btn-neutral float-right" title="Changelogs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2020, PopSim Consortium.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>